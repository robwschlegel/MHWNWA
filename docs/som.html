<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Robert Schlegel" />

<meta name="date" content="2019-06-04" />

<title>Self-organising map (SOM) analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MHW Northwest Atlantic</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="polygon-prep.html">Polygon preparation</a>
    </li>
    <li>
      <a href="sst-prep.html">SST preparation</a>
    </li>
    <li>
      <a href="var-prep.html">Variable preparation</a>
    </li>
    <li>
      <a href="vec-prep.html">Vector preparation</a>
    </li>
    <li>
      <a href="som.html">SOM analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/robwschlegel/MHWNWA">
    <span class="fa fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Self-organising map (SOM) analysis</h1>
<h4 class="author"><em>Robert Schlegel</em></h4>
<h4 class="date"><em>2019-06-04</em></h4>

</div>


<p><strong>Last updated:</strong> 2019-06-10</p>
<strong>workflowr checks:</strong> <small>(Click a bullet for more information)</small>
<ul>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>R Markdown file:</strong> up-to-date </summary></p>
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Environment:</strong> empty </summary></p>
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Seed:</strong> <code>set.seed(20190513)</code> </summary></p>
<p>The command <code>set.seed(20190513)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Session information:</strong> recorded </summary></p>
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Repository version:</strong> <a href="https://github.com/robwschlegel/MHWNWA/tree/c6b3c7bf45e652e3344cde203c6698e9a744698d" target="_blank">c6b3c7b</a> </summary></p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    data/NAPA_clim_U.Rda
    Ignored:    data/NAPA_clim_V.Rda
    Ignored:    data/NAPA_clim_W.Rda
    Ignored:    data/NAPA_clim_emp_ice.Rda
    Ignored:    data/NAPA_clim_emp_oce.Rda
    Ignored:    data/NAPA_clim_fmmflx.Rda
    Ignored:    data/NAPA_clim_mldkz5.Rda
    Ignored:    data/NAPA_clim_mldr10_1.Rda
    Ignored:    data/NAPA_clim_qemp_oce.Rda
    Ignored:    data/NAPA_clim_qla_oce.Rda
    Ignored:    data/NAPA_clim_qns.Rda
    Ignored:    data/NAPA_clim_qsb_oce.Rda
    Ignored:    data/NAPA_clim_qt.Rda
    Ignored:    data/NAPA_clim_runoffs.Rda
    Ignored:    data/NAPA_clim_ssh.Rda
    Ignored:    data/NAPA_clim_sss.Rda
    Ignored:    data/NAPA_clim_sst.Rda
    Ignored:    data/NAPA_clim_taum.Rda
    Ignored:    data/NAPA_clim_vars.Rda
    Ignored:    data/NAPA_clim_vecs.Rda
    Ignored:    data/node_mean_all_anom.Rda
    Ignored:    data/packet_all_anom.Rda
    Ignored:    data/som_all_anom.Rda
    Ignored:    data/synoptic_states.Rda
    Ignored:    data/synoptic_vec_states.Rda

Untracked files:
    Untracked:  output/som_plot_uoce_anom.pdf
    Untracked:  output/som_plot_voce_anom.pdf

Unstaged changes:
    Modified:   analysis/MHWNWA.bib
    Modified:   code/workflow.R
    Modified:   output/som_plot_mldr10_1_anom.pdf
    Modified:   output/som_plot_qt_anom.pdf
    Modified:   output/som_plot_sst_anom.pdf
    Modified:   output/som_plot_taum_anom.pdf

</code></pre>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</details>
</li>
</ul>
<details>
<summary> <small><strong>Expand here to see past versions:</strong></small> </summary>
<ul>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
File
</th>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
<th style="text-align:left;">
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/c6b3c7bf45e652e3344cde203c6698e9a744698d/analysis/som.Rmd" target="_blank">c6b3c7b</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-10
</td>
<td style="text-align:left;">
Re-publish entire site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/1b53eeb30e63f82f19ec3aa11b2a2befe88c5e66/analysis/som.Rmd" target="_blank">1b53eeb</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-10
</td>
<td style="text-align:left;">
SOM packet pipeline testing
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/4504e125b28f55766c189e57f88bfd2e45f8701e/analysis/som.Rmd" target="_blank">4504e12</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-07
</td>
<td style="text-align:left;">
Working on joining in vector data
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/c61a15f695d6d807427b5642f6e657830a527970/docs/som.html" target="_blank">c61a15f</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/44ac335c253cdc971d10cb55aa0d82ec27f52540/analysis/som.Rmd" target="_blank">44ac335</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Working on inclusion of vectors into SOM pipeline
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/6dd6da87ca5aa18617a30851b7f9cffe25ed7b10/docs/som.html" target="_blank">6dd6da8</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/07137d9327fc8ba24bc6a5586b0cc5117bb31d0c/analysis/som.Rmd" target="_blank">07137d9</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Site wide update, including newly functioning SOM pipeline.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/990693ab94b031163055c994db1364d56ac45c8d/analysis/som.Rmd" target="_blank">990693a</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-05
</td>
<td style="text-align:left;">
First SOM result visuals
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/25e7e9aa629a27698a15278713c14437a7717fed/analysis/som.Rmd" target="_blank">25e7e9a</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-05
</td>
<td style="text-align:left;">
SOM pipeline nearly finished
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/4838cc84c49dfd8bba7cc72cf5131cb56e9345b4/analysis/som.Rmd" target="_blank">4838cc8</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-04
</td>
<td style="text-align:left;">
Working on SOM functions
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/94ce8f67d95d2a30c7b904784e619457ee4907a7/analysis/som.Rmd" target="_blank">94ce8f6</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-04
</td>
<td style="text-align:left;">
Functions for creating data packets are up and running
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/65301edfa1c7e85df9bf0df7afc2bda432aef6b0/analysis/som.Rmd" target="_blank">65301ed</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-30
</td>
<td style="text-align:left;">
Push before getting rid of some testing structure
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/c09b4f7548427da023cfaf19ba517cb49e9456df/docs/som.html" target="_blank">c09b4f7</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-24
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/5dc8bd9ce2b868ebaefcc3ff83f0289672d22430/analysis/som.Rmd" target="_blank">5dc8bd9</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-24
</td>
<td style="text-align:left;">
Finished initial creation of SST prep vignette.
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/a29be6b35b7afe6b2b62ebeb324fbc7a1ef52e8e/docs/som.html" target="_blank">a29be6b</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-13
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/ea61999b0861c73ac1913d950d561693050fcfe7/docs/som.html" target="_blank">ea61999</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-13
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/f8f28b14f13d1c46a50daad9d9ee55eb037fc07f/analysis/som.Rmd" target="_blank">f8f28b1</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-05-13
</td>
<td style="text-align:left;">
Skeleton files
</td>
</tr>
</tbody>
</table>
</ul>
</details>
<hr />
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This markdown file will contain the code used to perform the self-organising map (SOM) analysis on the prepared variable data as seen in the <a href="https://robwschlegel.github.io/MHWNWA/var-prep.html">Variable preparation</a> vignette and on the prepared vectors seen in the <a href="https://robwschlegel.github.io/MHWNWA/var-prep.html">Vector preparation</a> vignette.</p>
<pre class="r"><code># Insatll from GitHub
# .libPaths(c(&quot;~/R-packages&quot;, .libPaths()))
# devtools::install_github(&quot;fabrice-rossi/yasomi&quot;)

# Packages used in this vignette
library(jsonlite, lib.loc = &quot;../R-packages/&quot;)
library(tidyverse) # Base suite of functions
library(ncdf4) # For opening and working with NetCDF files
library(lubridate) # For convenient date manipulation
# library(scales) # For scaling data before running SOM
library(yasomi, lib.loc = &quot;../R-packages/&quot;) # The SOM package of choice due to PCI compliance
library(data.table) # For working with massive dataframes

# Set number of cores
doMC::registerDoMC(cores = 50)

# Disable scientific notation for numeric values
  # I just find it annoying
options(scipen = 999)

# Set number of cores
doMC::registerDoMC(cores = 50)

# Disable scientific notation for numeric values
  # I just find it annoying
options(scipen = 999)

# Individual regions
NWA_coords &lt;- readRDS(&quot;data/NWA_coords_cabot.Rda&quot;)

# The NAPA variables
NAPA_vars &lt;- readRDS(&quot;data/NAPA_vars.Rda&quot;)

# Corners of the study area
NWA_corners &lt;- readRDS(&quot;data/NWA_corners.Rda&quot;)

# Create smaller corners to use less RAM
  # This also better matches the previous South African work
  # The Tasmania work had corners of roughly 2 degrees greater than the study area
NWA_corners_sub &lt;- c(NWA_corners[1]+8, NWA_corners[2]-8, NWA_corners[3]+8, NWA_corners[4]-8)

# The base map
map_base &lt;- ggplot2::fortify(maps::map(fill = TRUE, col = &quot;grey80&quot;, plot = FALSE)) %&gt;%
  dplyr::rename(lon = long) %&gt;%
  mutate(group = ifelse(lon &gt; 180, group+9999, group),
         lon = ifelse(lon &gt; 180, lon-360, lon)) %&gt;% 
  select(-region, -subregion)</code></pre>
</div>
<div id="possible-mechanisms" class="section level2">
<h2>Possible mechanisms</h2>
<p>“Finally, Shearman and Lentz (2010) showed that century-long ocean warming trends observed along the entire northeast U.S. coast are not related to local atmospheric forcing but driven by atmospheric warming of source waters in the Labrador Sea and the Arctic, which are advected into the region.” <span class="citation">(Richaud et al., 2016)</span></p>
<p>Downelling</p>
<p>Net heatflux (OAFlux) doesn’t line up perfectly with seasonal SST signal, but is very close, with heat flux tending to lead SST by 2 – 3 months.s <span class="citation">(Richaud et al., 2016)</span>. It is therefore likely one of the primary drivers of SST and should therefore be strongly considered when constructing SOMs.</p>
<p>There is almost no seasonal cycle for slope waters in any of the regions <span class="citation">(Richaud et al., 2016)</span>.</p>
</div>
<div id="more-ideas" class="section level2">
<h2>More ideas</h2>
<p>It would be interesting to see if the SOM outputs differ in any meaningful wayss when only data from the first half of the study time period are used compared against the second half.</p>
</div>
<div id="tailored-data-packets" class="section level2">
<h2>Tailored data packets</h2>
<p>In this last step before running our SOM analyses we want to create data packets that can be fed directly into the SOM algorithm. At the moment we will just create a packet for a few choice anomaly variables. This is because using all of the variables at once has proven to be too large a task. This is because we must create very wide dataframes (~80,000 columns) and R struggles with this. <!-- Specifically what we mean her is that we are going to filter the `synoptic_states` data created in the [Variable preparation](https://robwschlegel.github.io/MHWNWA/var-prep.html) vignette to match some pre-designed hypotheses. Foremost of these at the moment is that we want to create individual packets for each of the regions. While creating whatever packets we desire we will also be converting them into the super-wide matrix format that the SOM model desires. --></p>
<pre class="r"><code># Load the synoptic states data packet
synoptic_states &lt;- readRDS(&quot;data/synoptic_states.Rda&quot;)

# Load the synoptic vector states data packet
synoptic_vec_states &lt;- readRDS(&quot;data/synoptic_vec_states.Rda&quot;)

# Unnest the synoptic data
synoptic_states_unnest &lt;- synoptic_states %&gt;% 
  select(region, sub_region, event_no, synoptic) %&gt;% 
  unnest()

# NB: The range of values for mixed layer depth anomalies is muuuuch greater
  # in the Labrador sea than elsewhere in the study area.
  # So we scale it here first before feeding it into the SOM to be scaled again
synoptic_states_anom_fix &lt;- synoptic_states_unnest %&gt;% 
  select(region:lat, sst_anom, taum_anom, qt_anm, mldr10_1_anom) %&gt;% 
  # slice(1:100000) %&gt;% 
  group_by(lon, lat) %&gt;% 
  mutate(mldr10_1_anom = mldr10_1_anom/max(abs(mldr10_1_anom), na.rm = T)) %&gt;% 
  # na.omit() %&gt;% 
  ungroup()

# Unnest the synoptic vector data
synoptic_vec_states_unnest &lt;- synoptic_vec_states %&gt;% 
  select(region, sub_region, event_no, synoptic) %&gt;% 
  unnest() 

# NB: There is an issue downstream with one or more of the vector pixels always having a value of 0
  # This needs to be accounted for here before joining the data further
synoptic_vec_states_anom_fix &lt;- synoptic_vec_states_unnest %&gt;% 
  select(region:lat, uoce_anom:voce_anom) %&gt;% 
  group_by(lon, lat) %&gt;% 
  mutate(uoce_anom = case_when(min(uoce_anom, na.rm = T) != 0 &amp; max(uoce_anom, na.rm = T) != 0 ~ uoce_anom),
         voce_anom = case_when(min(voce_anom, na.rm = T) != 0 &amp; max(voce_anom, na.rm = T) != 0 ~ voce_anom)) %&gt;% 
  # na.omit() %&gt;% 
  ungroup()

# Set number of cores
  # NB: 50 uses too much RAM
doMC::registerDoMC(cores = 25)

# Packet for all synoptic anomaly data for all regions etc.
system.time(
packet_all_anom &lt;- left_join(synoptic_states_anom_fix, 
                             synoptic_vec_states_anom_fix,
                             by = c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;, &quot;lon&quot;, &quot;lat&quot;)) %&gt;% 
  # The variable dataframe is longer than the vector dataframe
  # na.omit() %&gt;% 
  # NB: A shortened list of variables to be more manageable
  # select(region:lat, sst_anom, taum_anom, qt_anm, 
         # mldr10_1_anom, uoce_anom, voce_anom) %&gt;% 
  # NB: The full list if one desires
  # select(region:lat, emp_oce_anom:taum_anom) %&gt;% 
  data.table::data.table() %&gt;% 
  filter(lon &gt;= NWA_corners_sub[1], lon &lt;= NWA_corners_sub[2],
         lat &gt;= NWA_corners_sub[3], lat &lt;= NWA_corners_sub[4]) %&gt;% 
  reshape2::melt(id = c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;, &quot;lon&quot;, &quot;lat&quot;),
                 measure = c(colnames(.)[-c(1:5)]), 
                 variable.name = &quot;var&quot;, value.name = &quot;val&quot;) %&gt;% 
  dplyr::arrange(var, lon, lat) %&gt;%
  # reshape2::dcast(formula = region + sub_region, event_no ~ lon + lat + var, value.var = &quot;val&quot;)
  unite(coords, c(lon, lat, var), sep = &quot;BBB&quot;) %&gt;%
  unite(event_ID, c(region, sub_region, event_no), sep = &quot;BBB&quot;) %&gt;%
  reshape2::dcast(event_ID ~ coords, value.var = &quot;val&quot;)
  # mutate(region_ply = region,
         # sub_region_ply = sub_region) %&gt;% 
  # plyr::ddply(c(&quot;region_ply&quot;, &quot;sub_region_ply&quot;), wide_matrix, .parallel = T) %&gt;% 
  # select(-region_ply, -sub_region_ply)
) # 367 seconds
# Remove columns (pixels) with missing data
packet_all_anom_fix &lt;- packet_all_anom[,colSums(is.na(packet_all_anom))&lt;1]
saveRDS(packet_all_anom_fix, &quot;data/packet_all_anom.Rda&quot;)</code></pre>
</div>
<div id="run-som-models" class="section level2">
<h2>Run SOM models</h2>
<p>Now that we have our anomaly data packet to feed the SOM, we need a function that will ingest them and produce results for us.</p>
<pre class="r"><code># Function for calculating SOMs using PCI
  # NB: 4x4 produced one empty cell and one cell with only one event
  # So the default size has been reduced to 4x3
som_model_PCI &lt;- function(data_packet, xdim = 4, ydim = 3){
  # Create a scaled matrix for the SOM
  # Cancel out first column as this is the reference ID of the event per row
  data_packet_matrix &lt;- as.matrix(scale(data_packet[,-1]))

  # Create the grid that the SOM will use to determine the number of nodes
  som_grid &lt;- somgrid(xdim = xdim, ydim = ydim, topo = &quot;hexagonal&quot;)

  # Run the SOM with PCI
  som_model &lt;- batchsom(data_packet_matrix,
                        somgrid = som_grid,
                        init = &quot;pca&quot;,
                        max.iter = 100)
  return(som_model)
}</code></pre>
<p>With the function sorted, we now feed the data.</p>
<pre class="r"><code>all_anom &lt;- readRDS(&quot;data/packet_all_anom.Rda&quot;)
system.time(som_all_anom &lt;- som_model_PCI(all_anom)) # 225 seconds
saveRDS(som_all_anom, file = &quot;data/som_all_anom.Rda&quot;)</code></pre>
</div>
<div id="unpack-som-results" class="section level2">
<h2>Unpack SOM results</h2>
<p>We will create two functions below that will be useful for unpacking the SOM results.</p>
<pre class="r"><code># Function for determining node indexes
# testers...
# data_packet &lt;- all_anom; som_output &lt;- som_all_anom
event_node_index &lt;- function(data_packet, som_output){
  
  # Count the number of events per node
  node_count &lt;- as.data.frame(table(som_output$classif)) %&gt;% 
    dplyr::rename(node = Var1,
                  count = Freq) %&gt;% 
    mutate(node = as.numeric(as.character(node)))
  
  # Create a more complete data.frame of info
  event_node &lt;- data.frame(event_ID = data_packet[,&quot;event_ID&quot;],
                           node = som_output$classif) %&gt;% 
    separate(event_ID, into = c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;), sep = &quot;BBB&quot;) %&gt;% 
    left_join(node_count, by = &quot;node&quot;)
  
  # NB: This is potentially where the season of the event would be inserted
  
  return(event_node)
}

# Functions for unpacking som results
  # Create mean results from initial data frame based on node clustering
# testers...
# data_packet &lt;- all_anom; som_output &lt;- som_all_anom
som_unpack_mean &lt;- function(data_packet, som_output){
  
  # Determine which event goes in which node and melt
  data_packet_long &lt;- data.frame(event_ID = data_packet[,&quot;event_ID&quot;],
                           node = som_output$classif) %&gt;% 
    separate(event_ID, into = c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;), sep = &quot;BBB&quot;) %&gt;% 
    cbind(data_packet[,-1]) %&gt;% 
    data.table() %&gt;% 
    reshape2::melt(id = c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;, &quot;node&quot;),
                   measure = c(colnames(.)[-c(1:4)]), 
                   variable.name = &quot;variable&quot;, value.name = &quot;value&quot;)
  
  # Create the mean values that serve as the unscaled results from the SOM
  var_unscaled &lt;- data_packet_long[, .(val = mean(value, na.rm = TRUE)),
                                   by = .(node, variable)] %&gt;% 
    separate(variable, into = c(&quot;lon&quot;, &quot;lat&quot;, &quot;var&quot;), sep = &quot;BBB&quot;) %&gt;%
    dplyr::arrange(node, var, lon, lat) %&gt;% 
    mutate(lon = as.numeric(lon),
           lat = as.numeric(lat))
  return(var_unscaled)
}</code></pre>
<p>And now we unpack the SOM results.</p>
<pre class="r"><code># Load data packet
all_anom &lt;- readRDS(&quot;data/packet_all_anom.Rda&quot;)

# Load SOM packet for anomaly data
som_all_anom &lt;- readRDS(&quot;data/som_all_anom.Rda&quot;)

# Determine node index
node_index_all_anom &lt;- event_node_index(all_anom, som_all_anom)

# Create and save mean synoptic states per node
node_mean_all_anom &lt;- som_unpack_mean(all_anom, som_all_anom)
# saveRDS(node_mean_all_anom, &quot;data/node_mean_all_anom.Rda&quot;)</code></pre>
</div>
<div id="visualise-som-results" class="section level2">
<h2>Visualise SOM results</h2>
<p>First up the functions for visualising the unpacked results.</p>
<pre class="r"><code># Ease of life function
som_node_visualise &lt;- function(sub_var = &quot;sst_anom&quot;, viridis_option = &quot;D&quot;){
  
  # Subset data
  node_mean_all_anom_sub &lt;- node_mean_all_anom %&gt;% 
    filter(var == sub_var) %&gt;% 
    mutate(lon = plyr::round_any(lon, 0.25),
           lat = plyr::round_any(lat, 0.25)) %&gt;% 
    group_by(node, lon, lat, var) %&gt;% 
    summarise(val = mean(val, na.rm = T))

  # Create plot
  som_panel_plot &lt;- ggplot(node_mean_all_anom_sub, aes(x = lon, y = lat)) +
    # geom_point(aes(colour = val)) +
    geom_raster(aes(fill  = val)) +
    geom_polygon(data = map_base, aes(group = group), show.legend = F) +
    geom_label(data = node_index_all_anom, aes(x = -60, y = 35, label = paste0(&quot;n = &quot;,count))) +
    # geom_polygon(data = NWA_coords, aes(group = region, fill = region, colour = region), alpha = 0.1) +
    coord_cartesian(xlim = NWA_corners_sub[1:2],
                    ylim = NWA_corners_sub[3:4], 
                    expand = F) +
    scale_fill_gradient2(low = &quot;blue&quot;, high = &quot;red&quot;) +
    # scale_colour_viridis_c(option = viridis_option) +
    labs(x = NULL, y = NULL, fill = sub_var) +
    facet_wrap(~node, ncol = 4) +
    theme(legend.position = &quot;bottom&quot;)
  return(som_panel_plot)
}</code></pre>
<p>And now we create a PDF for each of the 12 nodes for each variable individually.</p>
<pre class="r"><code># SST
plot_sst_anom &lt;- som_node_visualise(&quot;sst_anom&quot;)
# plot_sst_anom
ggsave(plot_sst_anom, filename = &quot;output/som_plot_sst_anom.pdf&quot;, height = 12, width = 13)

# Net downward heat flux (qt)
plot_qt_anom &lt;- som_node_visualise(&quot;qt_anm&quot;)
# plot_qt_anom
ggsave(plot_qt_anom, filename = &quot;output/som_plot_qt_anom.pdf&quot;, height = 12, width = 13)

# Mixed Layer Depth (mldr10_1)
plot_mldr10_1_anom &lt;- som_node_visualise(&quot;mldr10_1_anom&quot;)
# plot_mldr10_1_anom
ggsave(plot_mldr10_1_anom, filename = &quot;output/som_plot_mldr10_1_anom.pdf&quot;, height = 12, width = 13)

# Wind stress (taum)
plot_taum_anom &lt;- som_node_visualise(&quot;taum_anom&quot;)
# plot_taum_anom
ggsave(plot_taum_anom, filename = &quot;output/som_plot_taum_anom.pdf&quot;, height = 12, width = 13)

# Ocean current; U (uoce)
plot_uoce_anom &lt;- som_node_visualise(&quot;uoce_anom&quot;)
# plot_uoce_anom
ggsave(plot_uoce_anom, filename = &quot;output/som_plot_uoce_anom.pdf&quot;, height = 12, width = 13)

# Ocean current; U (uoce)
plot_voce_anom &lt;- som_node_visualise(&quot;voce_anom&quot;)
# plot_voce_anom
ggsave(plot_voce_anom, filename = &quot;output/som_plot_voce_anom.pdf&quot;, height = 12, width = 13)</code></pre>
<p>See the files in the <code>output/</code> folder in the GitHub repo for this project. They aren’t all shown here because they take a bit too long to render. But the following shows what the SST anomaly nodes look like.</p>
<pre class="r"><code>plot_sst_anom &lt;- som_node_visualise(&quot;sst_anom&quot;)
plot_sst_anom</code></pre>
<p><img src="figure/som.Rmd/plot-sst-anom-1.png" width="768" style="display: block; margin: auto;" /></p>
<p>Up next in the <a href="https://robwschlegel.github.io/MHWNWA/som.html">Figures</a> vignette we will show the results in more depth.</p>
<div id="refs">
<div id="ref-Richaud2016">
<p>Richaud, B., Kwon, Y.-O., Joyce, T. M., Fratantoni, P. S., and Lentz, S. J. (2016). Surface and bottom temperature and salinity climatology along the continental shelf off the canadian and us east coasts. <em>Continental Shelf Research</em> 124, 165–181.</p>
</div>
</div>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.6.0 (2019-04-26)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 16.04.5 LTS

Matrix products: default
BLAS:   /usr/lib/openblas-base/libblas.so.3
LAPACK: /usr/lib/libopenblasp-r0.2.18.so

locale:
 [1] LC_CTYPE=en_CA.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_CA.UTF-8    
 [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_CA.UTF-8   
 [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] bindrcpp_0.2.2    data.table_1.11.6 yasomi_0.3       
 [4] proxy_0.4-22      e1071_1.7-0       lubridate_1.7.4  
 [7] ncdf4_1.16        forcats_0.3.0     stringr_1.3.1    
[10] dplyr_0.7.6       purrr_0.2.5       readr_1.1.1      
[13] tidyr_0.8.1       tibble_1.4.2      ggplot2_3.0.0    
[16] tidyverse_1.2.1   jsonlite_1.6     

loaded via a namespace (and not attached):
 [1] tidyselect_0.2.4  reshape2_1.4.3    haven_1.1.2      
 [4] lattice_0.20-35   colorspace_1.3-2  htmltools_0.3.6  
 [7] yaml_2.2.0        rlang_0.2.2       R.oo_1.22.0      
[10] pillar_1.3.0      glue_1.3.0        withr_2.1.2      
[13] R.utils_2.7.0     doMC_1.3.5        modelr_0.1.2     
[16] readxl_1.1.0      foreach_1.4.4     bindr_0.1.1      
[19] plyr_1.8.4        munsell_0.5.0     gtable_0.2.0     
[22] workflowr_1.1.1   cellranger_1.1.0  rvest_0.3.2      
[25] R.methodsS3_1.7.1 codetools_0.2-15  evaluate_0.11    
[28] labeling_0.3      knitr_1.20        parallel_3.6.0   
[31] class_7.3-14      broom_0.5.0       Rcpp_0.12.18     
[34] backports_1.1.2   scales_1.0.0      hms_0.4.2        
[37] digest_0.6.16     stringi_1.2.4     grid_3.6.0       
[40] rprojroot_1.3-2   cli_1.0.0         tools_3.6.0      
[43] maps_3.3.0        magrittr_1.5      lazyeval_0.2.1   
[46] crayon_1.3.4      whisker_0.3-2     pkgconfig_2.0.2  
[49] xml2_1.2.0        iterators_1.0.10  assertthat_0.2.0 
[52] rmarkdown_1.10    httr_1.3.1        rstudioapi_0.7   
[55] R6_2.2.2          nlme_3.1-137      git2r_0.23.0     
[58] compiler_3.6.0   </code></pre>
</div>

<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

<hr>
<p>
  This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
  analysis was created with
  <a href="https://github.com/jdblischak/workflowr">workflowr</a> 1.1.1
</p>
<hr>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
