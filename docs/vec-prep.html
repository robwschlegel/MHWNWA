<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Robert Schlegel" />

<meta name="date" content="2019-06-06" />

<title>Vector preparation</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">MHW Northwest Atlantic</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Overview</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="polygon-prep.html">Polygon preparation</a>
    </li>
    <li>
      <a href="sst-prep.html">SST preparation</a>
    </li>
    <li>
      <a href="var-prep.html">Variable preparation</a>
    </li>
    <li>
      <a href="vec-prep.html">Vector preparation</a>
    </li>
    <li>
      <a href="som.html">SOM analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/robwschlegel/MHWNWA">
    <span class="fa fa-github"></span>
     
    Source code
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Vector preparation</h1>
<h4 class="author"><em>Robert Schlegel</em></h4>
<h4 class="date"><em>2019-06-06</em></h4>

</div>


<p><strong>Last updated:</strong> 2019-06-10</p>
<strong>workflowr checks:</strong> <small>(Click a bullet for more information)</small>
<ul>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>R Markdown file:</strong> up-to-date </summary></p>
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Environment:</strong> empty </summary></p>
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Seed:</strong> <code>set.seed(20190513)</code> </summary></p>
<p>The command <code>set.seed(20190513)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Session information:</strong> recorded </summary></p>
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</details>
</li>
<li>
<details>
<p><summary> <strong style="color:blue;">✔</strong> <strong>Repository version:</strong> <a href="https://github.com/robwschlegel/MHWNWA/tree/c6b3c7bf45e652e3344cde203c6698e9a744698d" target="_blank">c6b3c7b</a> </summary></p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility. The version displayed above was the version of the Git repository at the time these results were generated. <br><br> Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
<pre><code>
Ignored files:
    Ignored:    .Rhistory
    Ignored:    .Rproj.user/
    Ignored:    data/NAPA_clim_U.Rda
    Ignored:    data/NAPA_clim_V.Rda
    Ignored:    data/NAPA_clim_W.Rda
    Ignored:    data/NAPA_clim_emp_ice.Rda
    Ignored:    data/NAPA_clim_emp_oce.Rda
    Ignored:    data/NAPA_clim_fmmflx.Rda
    Ignored:    data/NAPA_clim_mldkz5.Rda
    Ignored:    data/NAPA_clim_mldr10_1.Rda
    Ignored:    data/NAPA_clim_qemp_oce.Rda
    Ignored:    data/NAPA_clim_qla_oce.Rda
    Ignored:    data/NAPA_clim_qns.Rda
    Ignored:    data/NAPA_clim_qsb_oce.Rda
    Ignored:    data/NAPA_clim_qt.Rda
    Ignored:    data/NAPA_clim_runoffs.Rda
    Ignored:    data/NAPA_clim_ssh.Rda
    Ignored:    data/NAPA_clim_sss.Rda
    Ignored:    data/NAPA_clim_sst.Rda
    Ignored:    data/NAPA_clim_taum.Rda
    Ignored:    data/NAPA_clim_vars.Rda
    Ignored:    data/NAPA_clim_vecs.Rda
    Ignored:    data/node_mean_all_anom.Rda
    Ignored:    data/packet_all_anom.Rda
    Ignored:    data/som_all_anom.Rda
    Ignored:    data/synoptic_states.Rda
    Ignored:    data/synoptic_vec_states.Rda

Untracked files:
    Untracked:  docs/figure/som.Rmd/
    Untracked:  output/som_plot_uoce_anom.pdf
    Untracked:  output/som_plot_voce_anom.pdf

Unstaged changes:
    Modified:   analysis/MHWNWA.bib
    Modified:   code/workflow.R
    Modified:   output/som_plot_mldr10_1_anom.pdf
    Modified:   output/som_plot_qt_anom.pdf
    Modified:   output/som_plot_sst_anom.pdf
    Modified:   output/som_plot_taum_anom.pdf

</code></pre>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</details>
</li>
</ul>
<details>
<summary> <small><strong>Expand here to see past versions:</strong></small> </summary>
<ul>
<table style="border-collapse:separate; border-spacing:5px;">
<thead>
<tr>
<th style="text-align:left;">
File
</th>
<th style="text-align:left;">
Version
</th>
<th style="text-align:left;">
Author
</th>
<th style="text-align:left;">
Date
</th>
<th style="text-align:left;">
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/c61a15f695d6d807427b5642f6e657830a527970/docs/vec-prep.html" target="_blank">c61a15f</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
html
</td>
<td style="text-align:left;">
<a href="https://cdn.rawgit.com/robwschlegel/MHWNWA/46b98f20c94f2ec57316e9a834e5290c3e7942ec/docs/vec-prep.html" target="_blank">46b98f2</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Build site.
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/49c610573c920e241a16a0ce72d593e1408b1e90/analysis/vec-prep.Rmd" target="_blank">49c6105</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Finished vector data packet pipeline
</td>
</tr>
<tr>
<td style="text-align:left;">
Rmd
</td>
<td style="text-align:left;">
<a href="https://github.com/robwschlegel/MHWNWA/blob/44ac335c253cdc971d10cb55aa0d82ec27f52540/analysis/vec-prep.Rmd" target="_blank">44ac335</a>
</td>
<td style="text-align:left;">
robwschlegel
</td>
<td style="text-align:left;">
2019-06-06
</td>
<td style="text-align:left;">
Working on inclusion of vectors into SOM pipeline
</td>
</tr>
</tbody>
</table>
</ul>
</details>
<hr />
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>It would seem logical that the U, V, and W vectors for water movement would be prepared at the same time as all of the other variables, as seen in the <a href="https://robwschlegel.github.io/MHWNWA/var-prep.html">Variable preparation</a> vignette. The issue we face with the vectors is that they are stored in the 3D version of the model, which has a 5 day temporal resolution. This means that they will need to be handled slightly differently from the rest of the variables. Largely though we should be able to adjust the functions previously created for the other variables.</p>
<pre class="r"><code># Packages used in this vignette
library(jsonlite, lib.loc = &quot;../R-packages/&quot;)
library(tidyverse) # Base suite of functions
library(ncdf4) # For opening and working with NetCDF files
library(lubridate) # For convenient date manipulation

# Load functions required below
source(&quot;code/functions.R&quot;)

# Set number of cores
doMC::registerDoMC(cores = 50)

# Disable scientific notation for numeric values
  # I just find it annoying
options(scipen = 999)

# Corners of the study area
NWA_corners &lt;- readRDS(&quot;data/NWA_corners.Rda&quot;)

# The NAPA surface data location
NAPA_files &lt;- dir(&quot;../../data/NAPA025/1d_grid_T_2D&quot;, full.names = T)

# The NAPA 5 day U vector data location
NAPA_U_files &lt;- dir(&quot;../../data/NAPA025/5d_grid_U&quot;, full.names = T)

# The NAPA 5 day V vector data location
NAPA_V_files &lt;- dir(&quot;../../data/NAPA025/5d_grid_V&quot;, full.names = T)

# The NAPA 5 day W vector data location
NAPA_W_files &lt;- dir(&quot;../../data/NAPA025/5d_grid_W&quot;, full.names = T)

# The NAPA model lon/lat values
NAPA_coords &lt;- readRDS(&quot;data/NAPA_coords.Rda&quot;)

# The NAPA model lon/lat values subsetted to the study area
NAPA_coords &lt;- readRDS(&quot;data/NAPA_coords_sub.Rda&quot;)

# Load NAPA bathymetry/lon/lat
NAPA_bathy &lt;- readRDS(&quot;data/NAPA_bathy.Rda&quot;)

# Load NAPA bathymetry/lon/lat subsetted to study area
NAPA_bathy &lt;- readRDS(&quot;data/NAPA_bathy_sub.Rda&quot;)

# Load MHW results
NAPA_MHW_sub &lt;- readRDS(&quot;data/NAPA_MHW_sub.Rda&quot;)

# MHW Events
NAPA_MHW_event &lt;- NAPA_MHW_sub %&gt;%
  select(-clims, -cats) %&gt;%
  unnest(events) %&gt;%
  filter(row_number() %% 2 == 0) %&gt;%
  unnest(events)</code></pre>
</div>
<div id="vector-variables" class="section level2">
<h2>Vector variables</h2>
<p>We obviously want the primary vectors from the model, but I noticed that there are other things stored in these 5 day NetCDf files, so let’s have a closer look.</p>
<pre class="r"><code># The U variables
NAPA_U &lt;- ncdump::NetCDF(NAPA_U_files[1])$variable[1:6]
NAPA_U</code></pre>
<pre><code># A tibble: 9 x 6
  name           ndims natts prec   units                longname         
  &lt;chr&gt;          &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;                &lt;chr&gt;            
1 depthu_bounds      2     0 float  &quot;&quot;                   depthu_bounds    
2 e3u                4    10 float  m                    U-cell thickness 
3 nav_lat            2     3 float  degrees_north        Latitude         
4 nav_lon            2     3 float  degrees_east         Longitude        
5 time_centered      1     6 double seconds since 1900-… Time axis        
6 time_centered…     2     0 double &quot;&quot;                   time_centered_bo…
7 time_counter_…     2     0 double &quot;&quot;                   time_counter_bou…
8 uoce               4    10 float  m/s                  Sea Water X Velo…
9 utau               3    10 float  N/m2                 Surface Downward…</code></pre>
<pre class="r"><code># The V variables
NAPA_V &lt;- ncdump::NetCDF(NAPA_V_files[1])$variable[1:6]
NAPA_V</code></pre>
<pre><code># A tibble: 9 x 6
  name           ndims natts prec   units                longname         
  &lt;chr&gt;          &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;                &lt;chr&gt;            
1 depthv_bounds      2     0 float  &quot;&quot;                   depthv_bounds    
2 e3v                4    10 float  m                    V-cell thickness 
3 nav_lat            2     3 float  degrees_north        Latitude         
4 nav_lon            2     3 float  degrees_east         Longitude        
5 time_centered      1     6 double seconds since 1900-… Time axis        
6 time_centered…     2     0 double &quot;&quot;                   time_centered_bo…
7 time_counter_…     2     0 double &quot;&quot;                   time_counter_bou…
8 voce               4    10 float  m/s                  Sea Water Y Velo…
9 vtau               3    10 float  N/m2                 Surface Downward…</code></pre>
<pre class="r"><code># The W variables
NAPA_W &lt;- ncdump::NetCDF(NAPA_W_files[1])$variable[1:6]
NAPA_W</code></pre>
<pre><code># A tibble: 8 x 6
  name           ndims natts prec   units                longname         
  &lt;chr&gt;          &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;chr&gt;                &lt;chr&gt;            
1 avt                4    10 float  m2/s                 vertical eddy di…
2 depthw_bounds      2     0 float  &quot;&quot;                   depthw_bounds    
3 nav_lat            2     3 float  degrees_north        Latitude         
4 nav_lon            2     3 float  degrees_east         Longitude        
5 time_centered      1     6 double seconds since 1900-… Time axis        
6 time_centered…     2     0 double &quot;&quot;                   time_centered_bo…
7 time_counter_…     2     0 double &quot;&quot;                   time_counter_bou…
8 wo                 4    10 float  m/s                  ocean vertical v…</code></pre>
<p>It appears that the U and V files also contain their corresponding downward stress (<code>utau</code> and <code>vtau</code>), though with the availability of the W vectors, I don’t know that we need these, too. For now we will just stick with: <code>uoce</code>, <code>voce</code>, and <code>wo</code>.</p>
</div>
<div id="synoptic-states" class="section level2">
<h2>Synoptic states</h2>
<p>As with the other variables, we will also need to create mean synoptic states of the vectors (U, V, W) during all of the recorded MHWs. From here out we will again be running on data stored on a local server, meaning the following code won’t be of much use unless one has a copy of the NAPA model data. The resulting synoptic states we will create now are likely to be in excess of a couple of GB so will not be hosted on the public GitHub server either. They are of course available upon request.</p>
<div id="date-index-for-napa-vector-files" class="section level3">
<h3>Date index for NAPA vector files</h3>
<p>To create the index of dates to be found within each of the thousands of NAPA 5 day vector NetCDF files we will use the same simple for loop to crawl through the files and write down for us in one long spreadsheet which dates are to be found in which files. This worked well for the previous vignette, so I’ve kept this step the same. The vectors are stored in three different file directories, but their dates are the same, so we only need to create one date index file, not three individual ones.</p>
<pre class="r"><code># Pull out the dates
NAPA_vector_files_dates &lt;- data.frame()
for(i in 1:length(NAPA_files)){
  file_name &lt;- NAPA_U_files[i]
  date_start &lt;- ymd(str_sub(basename(as.character(file_name)), start = 26, end = 33))
  date_end &lt;- ymd(str_sub(basename(as.character(file_name)), start = 35, end = 43))
  date_seq &lt;- seq(date_start, date_end, by = &quot;day&quot;)
  # Take the middle date as this is the real data in the pentad
  date_info &lt;- data.frame(file = file_name, date = date_seq[3])
  NAPA_vector_files_dates &lt;- rbind(date_info, NAPA_vector_files_dates)
}

# Order by date, just for tidiness
NAPA_vector_files_dates &lt;- dplyr::arrange(NAPA_vector_files_dates, date)

# Save
# saveRDS(NAPA_vector_files_dates, &quot;data/NAPA_vector_files_dates.Rda&quot;)</code></pre>
</div>
<div id="variable-climatologies" class="section level3">
<h3>Variable climatologies</h3>
<p>Part of the data packet we need to create for the SOMs is the anomaly values. In order to create anomalies however we need to first create climatologies for all of the variables. This may prove to be a somewhat daunting task, but it’s what we are here to do! In order to create a climatology of values we will need to load all of the files and then pixel-wise go about getting the seasonal (daily) climatologies. This will be done with the same function (<code>ts2clm()</code>) that is used for the MHW climatologies. We will first create a function that extracts the desired variables from any NetCDF files fed to it. With that done it should be a routine matter to get the climatologies. Hold onto your hats, this is going to be RAM heavy…</p>
<pre class="r"><code># Load functions required below
source(&quot;code/functions.R&quot;)

# U
clim_one_vec(NAPA_U_files)
gc()

# V
clim_one_vec(NAPA_V_files)
gc()

# W
clim_one_vec(NAPA_W_files)
gc()</code></pre>
<p>And then combine them into one big clim file.</p>
<pre class="r"><code># Load all variable climatologies
NAPA_clim_U &lt;- readRDS(&quot;data/NAPA_clim_U.Rda&quot;)
NAPA_clim_V &lt;- readRDS(&quot;data/NAPA_clim_V.Rda&quot;)
NAPA_clim_W &lt;- readRDS(&quot;data/NAPA_clim_W.Rda&quot;)

# left join them
NAPA_clim_vecs &lt;- left_join(NAPA_clim_U, NAPA_clim_V, by = c(&quot;lon&quot;, &quot;lat&quot;, &quot;doy&quot;)) %&gt;% 
  left_join(NAPA_clim_W, by = c(&quot;lon&quot;, &quot;lat&quot;, &quot;doy&quot;))

# Convert DOY to MM-DD for joining to daily data below
NAPA_clim_vecs$doy &lt;- format(as.Date(NAPA_clim_vecs$doy, origin = &quot;2015-12-31&quot;), &quot;%m-%d&quot;)

# Change column names to highlight that these are climatology values
colnames(NAPA_clim_vecs)[-c(1:3)] &lt;- paste0(colnames(NAPA_clim_vecs)[-c(1:3)],&quot;_clim&quot;)

# Save
saveRDS(NAPA_clim_vecs, &quot;data/NAPA_clim_vecs.Rda&quot;)
rm(NAPA_clim_U, NAPA_clim_V, NAPA_clim_W); gc()</code></pre>
</div>
<div id="variable-extractor" class="section level3">
<h3>Variable extractor</h3>
<p>We needed a list of the dates present in each file so that we can easily load only the NetCDF files we need to extract our desired variables. The dates we want are the range of dates during each of the MHWs detected in the <a href="https://robwschlegel.github.io/MHWNWA/sst-prep.html">SST preparation</a> vignette. In the chunk below we will create a function that decides which files should have their variables loaded and a function that binds everything up into tidy data packets that our SOM can ingest.</p>
<pre class="r"><code># Load NAPA file date index
NAPA_vector_files_dates &lt;- readRDS(&quot;data/NAPA_vector_files_dates.Rda&quot;)

# Load full variable climatology file
NAPA_clim_vecs &lt;- readRDS(&quot;data/NAPA_clim_vecs.Rda&quot;)

# Function for extracting the desired variables from a given NetCDF file
# testers...
# file_number &lt;- 1376
extract_all_vec &lt;- function(file_number){
  
  # Extract and join variables with a for loop
    # NB: This should be optimised...
  u_vecs &lt;- extract_one_vec(NAPA_U_files[file_number])
  v_vecs &lt;- extract_one_vec(NAPA_V_files[file_number])
  if(file_number == 276){
    w_vecs &lt;- v_vecs[1,]
    colnames(w_vecs)[6] &lt;- &quot;wo&quot;
  } else {
    w_vecs &lt;- extract_one_vec(NAPA_W_files[file_number])
  }
  
  NAPA_vecs_extracted &lt;- left_join(u_vecs, v_vecs, by = colnames(u_vecs)[1:5]) %&gt;% 
    left_join(w_vecs, by = colnames(u_vecs)[1:5])
  
  # Exit
  return(NAPA_vecs_extracted)
}

# Function for extracting variables from as many files as a MHW event requires
# testers...
# event_sub &lt;- NAPA_MHW_event[23,]
data_vec_packet &lt;- function(event_sub){
  
  # Create date and file index for loading
  date_idx &lt;- seq(event_sub$date_start, event_sub$date_end, by = &quot;day&quot;)
  file_idx &lt;- which(NAPA_vector_files_dates$date %in% date_idx)
  
  # Load required base data
  # system.time(
  packet_base &lt;- plyr::ldply(file_idx, extract_all_vec) %&gt;% 
    filter(t %in% date_idx) %&gt;%
    mutate(doy = format(t, &quot;%m-%d&quot;))
  # ) # 16 seconds for seven files
  
  # Join to climatologies
  packet_join &lt;- left_join(packet_base, NAPA_clim_vecs, by = c(&quot;lon&quot;, &quot;lat&quot;, &quot;doy&quot;))
  
  # Create anomaly values and remove clim columns
  packet_anom &lt;- packet_join %&gt;% 
    mutate(uoce_anom = uoce - uoce_clim,
           voce_anom = voce - voce_clim,
           wo_anom = wo - wo_clim) %&gt;% 
    dplyr::select(lon, lat, doy, uoce:wo_anom, 
                  -c(colnames(NAPA_clim_vecs)[-c(1:3)]))
  
  # Create mean synoptic values
  packet_mean &lt;- packet_anom %&gt;% 
    select(-doy) %&gt;% 
    # NB: The lowest pixels are a forcing edge and shouldn&#39;t be included
      # We can catch these out by filtering pixels whose SST is exactly 0
    # filter(sst != 0) %&gt;% 
    group_by(lon, lat) %&gt;% 
    summarise_all(mean, na.rm = T) %&gt;% 
    arrange(lon, lat) %&gt;% 
    ungroup() %&gt;% 
    nest(.key = &quot;synoptic&quot;)
  
  # Combine results with MHW dataframe
  packet_res &lt;- cbind(event_sub, packet_mean)
  
  # Test visuals
  # ggplot(packet_mean, aes(x = lon, y = lat)) +
  #   geom_point(aes(colour = uoce_anom)) +
  #   scale_colour_gradient2(low = &quot;blue&quot;, high = &quot;red&quot;) +
  #   coord_cartesian(xlim = NWA_corners[1:2],
  #                   ylim = NWA_corners[3:4])
  
  # Exit
  return(packet_res)
}</code></pre>
<p>With our functions sorted, it is now time to create our data packets.</p>
<pre class="r"><code># Set number of cores
  # NB: Was set to 25 as someone else was using the server at the time
doMC::registerDoMC(cores = 25)

# Create one big packet
system.time(
synoptic_vec_states &lt;- plyr::ddply(NAPA_MHW_event, c(&quot;region&quot;, &quot;sub_region&quot;, &quot;event_no&quot;), data_vec_packet, .parallel = T)
) # 28 seconds for first 2, 6125 seconds (102 minutes) for all

# Save
# saveRDS(synoptic_vec_states, &quot;data/synoptic_vec_states.Rda&quot;)</code></pre>
<p>With all of our synoptic snapshots for our chosen variables created it is now time to feed them to the <a href="https://robwschlegel.github.io/MHWNWA/som.html">Self-organising map (SOM) analysis</a>.</p>
<div id="refs">

</div>
</div>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.6.0 (2019-04-26)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 16.04.5 LTS

Matrix products: default
BLAS:   /usr/lib/openblas-base/libblas.so.3
LAPACK: /usr/lib/libopenblasp-r0.2.18.so

locale:
 [1] LC_CTYPE=en_CA.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_CA.UTF-8        LC_COLLATE=en_CA.UTF-8    
 [5] LC_MONETARY=en_CA.UTF-8    LC_MESSAGES=en_CA.UTF-8   
 [7] LC_PAPER=en_CA.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_CA.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] bindrcpp_0.2.2       tidync_0.2.1         heatwaveR_0.3.6.9004
 [4] data.table_1.11.6    lubridate_1.7.4      ncdf4_1.16          
 [7] forcats_0.3.0        stringr_1.3.1        dplyr_0.7.6         
[10] purrr_0.2.5          readr_1.1.1          tidyr_0.8.1         
[13] tibble_1.4.2         ggplot2_3.0.0        tidyverse_1.2.1     
[16] jsonlite_1.6        

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.18      lattice_0.20-35   utf8_1.1.4       
 [4] assertthat_0.2.0  rprojroot_1.3-2   digest_0.6.16    
 [7] foreach_1.4.4     R6_2.2.2          cellranger_1.1.0 
[10] plyr_1.8.4        backports_1.1.2   evaluate_0.11    
[13] httr_1.3.1        pillar_1.3.0      rlang_0.2.2      
[16] lazyeval_0.2.1    readxl_1.1.0      ncmeta_0.0.4     
[19] rstudioapi_0.7    whisker_0.3-2     R.utils_2.7.0    
[22] R.oo_1.22.0       rmarkdown_1.10    htmlwidgets_1.3  
[25] munsell_0.5.0     broom_0.5.0       compiler_3.6.0   
[28] modelr_0.1.2      pkgconfig_2.0.2   htmltools_0.3.6  
[31] tidyselect_0.2.4  workflowr_1.1.1   codetools_0.2-15 
[34] doMC_1.3.5        fansi_0.3.0       viridisLite_0.3.0
[37] crayon_1.3.4      withr_2.1.2       R.methodsS3_1.7.1
[40] grid_3.6.0        nlme_3.1-137      gtable_0.2.0     
[43] git2r_0.23.0      magrittr_1.5      scales_1.0.0     
[46] cli_1.0.0         stringi_1.2.4     xml2_1.2.0       
[49] iterators_1.0.10  tools_3.6.0       glue_1.3.0       
[52] RNetCDF_1.9-1     maps_3.3.0        hms_0.4.2        
[55] ncdump_0.0.3      parallel_3.6.0    yaml_2.2.0       
[58] colorspace_1.3-2  rvest_0.3.2       plotly_4.9.0     
[61] knitr_1.20        bindr_0.1.1       haven_1.1.2      </code></pre>
</div>

<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>

<hr>
<p>
  This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a>
  analysis was created with
  <a href="https://github.com/jdblischak/workflowr">workflowr</a> 1.1.1
</p>
<hr>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
